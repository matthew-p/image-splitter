<!DOCTYPE html>
<html>
  <head>
    <title>Image Splitter</title>
    <!-- Latest Bootstrap compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>
  <body bgcolor="grey">
    <nav class="navbar navbar-inverse navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Image Splitter</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <p>
        This is a small utility to make a png from a randomized arrangment of 'tiles' (rectangular subportions) from a tileset image, such as those you can find on <a href="http://opengameart.org/">OpenGameArt.org</a>. It will display the source image with each selected tile outlined by a 2px highlight above the randomized output image. It updates whenever you change the selected tileset image.
      </p>
      <p>
        The tile width and height are treated as the same across the entire image. You indicate which tiles out of the image you wish to use in the 'List of Tiles to Use' field, with each tile selected by giving its column & row values separated by a comma ",", and each tile entry separated by a space " " character, zero-indexed. 'Column' and 'row' here refers to how many tile-widths over & tile-heights down to look from the starting upper left corner of the tileset image. Ie, to use the first two tiles from the upper-leftmost corner of the tileset, you would enter:
      </p>
      <p>
        0,0 1,0
      </p>
      <p>
        While to use the two left-most tiles from the top two rows of the tileset image, you would enter:
      </p>
      <p>
        0,0 1,0 0,1 1,1
      </p>

      <p>
        Repeating an entry in the list will increase its likelihood of appearing.
      </p>

      <p>
      Tile Width in Pixels: <input type="number" id="tile-width" value="16"><br>
      Tile Height in Pixels: <input type="number" id="tile-height" value="16"><br>
      Output Width in Tiles: <input type="number" id="output-width" value="8"><br>
      Output Height in Tiles: <input type="number" id="output-height" value="8"><br>
      List of Tiles to Use: <input type="text" id="tiles-to-use" value="0,0"><br>
      Tileset Image: <input type="file" id="tileset" autofocus="true"><br>
      </p>

      <div id="output">
        <p>Input Image Tiles:</p>
        <canvas id="image-canvas"></canvas>
      </div>
      <div>
        <p>PNG Output:</p>
        <img src="" id="output-image">
      </div>
    </div>

      <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

        <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script>
      var imageLoader = document.getElementById("tileset");
      imageLoader.addEventListener("change", handleImage, false);

      function handleImage(e) {
        var tileWidth = document.getElementById("tile-width").value || 16;
        var tileHeight = document.getElementById('tile-height').value || 16;
        var outputWidth = document.getElementById('output-width').value || 4;
        var outputHeight = document.getElementById("output-height").value || 3;
        var tilesToUse = document.getElementById("tiles-to-use").value.split(/\s/);
        tilesToUse = tilesToUse.map(function(element) {
          return element.split(",");
        });

        var inputCanvas = document.getElementById("image-canvas");
        var inputCtx = inputCanvas.getContext("2d");


        var outputCanvas = document.createElement("canvas");
        var ctx = outputCanvas.getContext("2d");

        ctx.canvas.width = tileWidth * outputWidth;
        ctx.canvas.height = tileHeight * outputHeight;

        function drawInput(img, tilesToUse, inputCtx) {
          inputCtx.canvas.width = img.width;
          inputCtx.canvas.height = img.height;
          inputCtx.drawImage(img, 0, 0);
          inputCtx.lineWidth = 2;
          inputCtx.strokeStyle = "rgb(255,0,0)";
          for (var i = 0; i < tilesToUse.length; i++) {
            inputCtx.strokeRect(tilesToUse[i][0] * tileWidth, tilesToUse[i][1] * tileHeight, tileWidth, tileHeight);
          }

        };

        function drawTiles(img, tilesToUse) {
          for (var i = 0; i < outputHeight; i++) {
            for (var j = 0; j < outputWidth; j++) {
              // pull random tile
              var randomTile = tilesToUse[Math.floor(Math.random() * tilesToUse.length)];
              console.log("curr randomTile: " + randomTile);
              ctx.drawImage(img, randomTile[0] * tileWidth, randomTile[1] * tileHeight, tileWidth, tileHeight, j * tileWidth, i * tileHeight, tileWidth, tileHeight);
            }
          }
          saveRender();
        };

        // render to png on page
        function saveRender() {
          console.log("dataurl: " + outputCanvas.toDataURL());
          document.getElementById("output-image").src = outputCanvas.toDataURL();
        };


        var reader = new FileReader();
        reader.onload = function(event) {
          var img = new Image();
          img.onload = function() {
            drawInput(img, tilesToUse, inputCtx);
            drawTiles(img, tilesToUse);
          }
          img.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
      };



    </script>


  </body>
</html>
